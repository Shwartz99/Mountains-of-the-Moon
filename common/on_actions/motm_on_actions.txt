#When adding effects directly in on_actions always consider if it would be best to do so through a scripted effect. on_actions with a lot of script in them are harder to get an overview of.

# country
on_startup = {
	emperor = {
		save_global_event_target_as = Emperor
	}
	if = {
		limit = {
			has_dlc = "Mandate of Heaven"
		}
		if = {
			limit = { is_emperor_of_china = yes }
			save_global_event_target_as = EmperorOfChina
		}
	}
	else = {
		if = {
			limit = { has_reform = celestial_empire }
			save_global_event_target_as = EmperorOfChina
		}
	}
	events = {
		muslim_school_events.20 #Pick School
		flavor_mng.42 #Event for the starting situation of the Ming 
		flavor_got.1 #Event for Gotland to select their mission tree
		#flavor_fra.15000 #Make the French Revolution happen if starting in 1789
		flavor_mos.1 #Event regarding the Tatar Yoke
		flavor_fra.206 # Setup the general for missions
		flavor_geo.1 # Disaster info
		flavor_mam.111 # Mamluks-Syria relations
	}
	on_startup_effect = yes
	on_startup_dlc_cleanup_effect = yes
	initialize_schools_effect = yes #This is only used here but is used for readability of on_action file.
	if = {
		limit = { has_estate = estate_slaves }
		add_estate_loyalty = {
			estate = estate_slaves
			loyalty = -20
		}
		set_country_flag = slaves_post_startup
		export_to_variable = {
			which = crown_land_initial
			value = trigger_value:crown_land_share
		}
	}
}

# #Unit Scope OnAction for Battle Lost
on_battle_lost_unit = {
	on_battle_lost_unit_effect = yes
    if = {
        limit = {
            unit_owner = {
                tag = MNG
                has_ruler_flag = mng_militry_incompetence
            }
            is_ruler_commanding_unit = yes
			enemy_unit = {
				unit_owner = {
					tag = OIR
				}
			}
        }
        OIR = {
            country_event = { id = flavor_oir.2 }
        }
    }
    if = {
        limit = {
            unit_owner = {
                tag = JOL
                has_disaster = decline_of_jolof
            }
            is_ruler_commanding_unit = yes
			enemy_unit = {
				unit_owner = {
					tag = KAY
				}
			}
        }
        KAY = {
			country_event = { id = motm_decline_of_jolof.7 }
		}
    }
}

# Nation is integrated after being in union
on_integrate = {
	if = {
		limit = {
			has_country_flag = hun_integrate_pu_bonus
			FROM = { junior_union_with = ROOT }
		}
		if = {
			limit = {
				has_dlc = "Mandate of Heaven"
			}
			add_splendor = 100
		}
		else = {
			add_dip_power = 100
		}
	}
	events = {
		610
	}
	if = {
		limit = { has_estate = estate_slaves }
		distribute_land_effect = { estate = estate_slaves }
	}
}

# province
on_adm_development = {
	on_development_effect = { type = adm }
	owner = {
		if = {
			limit = { has_estate = estate_slaves }
			distribute_land_effect = { estate = estate_slaves }
		}
	}
}

# province
on_dip_development = {
	on_development_effect = { type = dip }
	owner = {
		if = {
			limit = { has_estate = estate_slaves }
			distribute_land_effect = { estate = estate_slaves }
		}
	}
}

# province
on_mil_development = {
	on_development_effect = { type = mil }
	owner = {
		if = {
			limit = { has_estate = estate_slaves }
			distribute_land_effect = { estate = estate_slaves }
		}
	}
}

# ROOT = New vassal, FROM = Overlord
on_create_vassal = {
	on_religion_change_estate_privileges_effect = yes
	if = {
		limit = {
			tag = TUR
			HUN = { has_country_modifier = hun_avenge_varna }
		}
		HUN = { remove_country_modifier = hun_avenge_varna }
	}
	if = {
		limit = {
			ai = no
			tag = BOH
			has_dlc = "Winds of Change"
			not_in_mission_preview_mode = { key = BOH_RELIGION }
			NOT = { mission_completed = boh_hussite_regency }
		}
		enable_branching_mission_review_without_ai  = {
			key = BOH_RELIGION
		}
	}
    if = {
        limit = {
			ai = no
            tag = HSN
            has_dlc = "Winds of Change"
			not_in_mission_preview_mode = { key = HSN }
			NOT = { mission_completed = hsn_fate_of_anatolia }
        }
        enable_branching_mission_review_without_ai  = {
            key = HSN
        }
    }
    if = {
        limit = {
			ai = no
            tag = HSN
            has_dlc = "Winds of Change"
			not_in_mission_preview_mode = { key = HSN2 }
			NOT = { mission_completed = hsn_sultan_shah }
        }
        enable_branching_mission_review_without_ai  = {
            key = HSN2
        }
    }
	if = {
		limit = {
			has_dlc = "Emperor"
			FROM = {
				is_revolutionary = yes
			}
		}
		change_government = republic
		add_government_reform = junior_revolutionary_republic_reform
		set_country_flag = had_revolution
	}
	if = {
		limit = {
			tag = PAP
		}
		change_government = theocracy
		change_religion = catholic
		add_government_reform = papacy_reform
		adopt_reform_progress = FROM
	}
	if = {
		limit = { NOT = { is_year = 1445 } }
		set_country_flag = released_in_1444
	}
	FROM = {
		if = {
			limit = { has_estate = estate_slaves }
			distribute_land_effect = { estate = estate_slaves }
		}
	}
	ROOT = {
		if = {
			limit = { has_estate = estate_slaves }
			add_estate_loyalty = {
				estate = estate_slaves
				loyalty = -20
			}
			set_country_flag = slaves_post_startup
			export_to_variable = {
				which = crown_land_initial
				value = trigger_value:crown_land_share
			}
		}
	}
}

# ROOT = Country establishing it
# First province in state is set
on_holy_order_established = {
	ROOT = {
		if = {
			limit = {
				has_country_flag = ven_establish_scuola_effect_flag
			}
			change_innovativeness = 1
		}
		if = {
			limit = { has_estate = estate_slaves }
			distribute_land_effect = { estate = estate_slaves }
		}
	}
}

# THIS = Raiding country, FROM = Sea province
on_raid_coast = {
	if = {
		limit = {
			has_faction = pr_buccaneers
		}
		add_faction_influence = {
			faction = pr_buccaneers
			influence = 1
		}
	}
	if = {
		limit = {
			has_government_attribute = raiding_increases_pp
		}
		add_power_projection = {
			type = high_sea_power_projection
			amount = 1
		}
	}
	if = {
		limit = {
			has_mission = dan_raid_the_north_sea
			NOT = { mission_completed = dan_raid_the_north_sea } 
		}
		change_variable = {
			which = num_of_raided_coasts
			value = 1
		}
	}
	if = {
		limit = {
			has_estate = estate_slaves
		}
		add_estate_influence_modifier = {
			estate = estate_slaves
			desc = EST_VAL_RAIDED_COAST
			influence = 20
			duration = 365
		}
	}
}

# this = Released country, FROM = Releasing country
on_country_released = {
	if = {
		limit = {
			ai = no
			tag = BOH
			has_dlc = "Winds of Change"
			not_in_mission_preview_mode = { key = BOH_RELIGION }
			NOT = { mission_completed = boh_hussite_regency }
		}
		enable_branching_mission_review_without_ai  = {
			key = BOH_RELIGION
		}
	}
    if = {
        limit = {
			ai = no
            tag = HSN
            has_dlc = "Winds of Change"
			not_in_mission_preview_mode = { key = HSN }
			NOT = { mission_completed = hsn_fate_of_anatolia }
        }
        enable_branching_mission_review_without_ai  = {
            key = HSN
        }
    }
    if = {
        limit = {
			ai = no
            tag = HSN
            has_dlc = "Winds of Change"
			not_in_mission_preview_mode = { key = HSN2 }
			NOT = { mission_completed = hsn_sultan_shah }
        }
        enable_branching_mission_review_without_ai  = {
            key = HSN2
        }
    }
	if = {
		limit = {
			tag = PAP
		}
		change_government = theocracy
		change_religion = catholic
		add_government_reform = papacy_reform
		adopt_reform_progress = FROM
	}
	if = {
		limit = {
			FROM = { has_reform = religious_permanent_revolution_reform }
			NOT = { tag = PAP }
		}
		change_religion = FROM
		adopt_reform_progress = FROM
		add_country_modifier = {
			name = global_holy_war_released_modifier
			duration = 3650
			hidden = yes
		}
		capital_scope = {
			change_religion = FROM
		}
	}
	if = {
		limit = { NOT = { is_year = 1445 } }
		set_country_flag = released_in_1444
	}
	FROM = {
		if = {
			limit = { has_estate = estate_slaves }
			distribute_land_effect = { estate = estate_slaves }
		}
	}
	if = {
		limit = { has_estate = estate_slaves }
		add_estate_loyalty = {
			estate = estate_slaves
			loyalty = -20
		}
		set_country_flag = slaves_post_startup
	}
}

# this = country
on_rebels_break_country = {
	add_country_modifier = {
		name = just_lost_to_rebels
		duration = 10
		hidden = yes
	}
	if = {
		limit = { has_estate = estate_slaves }
		distribute_land_effect = { estate = estate_slaves }
	}
	events = {
		flavor_per.64	#No more Zoroastrian
	}
}

# this = new client state, from = parent country
on_create_client_state = {
	if = { 
		limit = { 
			FROM = { mission_completed = fra_grande_armee }
		}
		FROM = {
			add_power_projection = {
				type = mission_rewards_power_projection
				amount = 10
			}
		}
	}
	FROM = {
		if = {
			limit = { has_estate = estate_slaves }
			distribute_land_effect = { estate = estate_slaves }
		}
	}
	if = {
		limit = { has_estate = estate_slaves }
		add_estate_loyalty = {
			estate = estate_slaves
			loyalty = -20
		}
		set_country_flag = slaves_post_startup
	}
}

on_country_creation = {
	if = {
		limit = {
			tag = PAP
			OR = {
				NOT = {
					religion = catholic
				}
				NOT = {
					has_reform = papacy_reform
				}
				NOT = {
					government = theocracy
				}
			}
		}
		change_religion = catholic
		change_government = theocracy
		add_government_reform = papacy_reform
	}
	if = {
		limit = { has_estate = estate_slaves }
		add_estate_loyalty = {
			estate = estate_slaves
			loyalty = -20
		}
		set_country_flag = slaves_post_startup
	}
}

#FROM = country pillaged, ROOT = country doing the pillaging
on_pillaged_capital = {
	slave_raid_pillage_capital_effect = yes
	FROM = {
		if = {
			limit = { has_estate = estate_slaves }
			distribute_land_effect = { estate = estate_slaves }
		}
	}
	ROOT = {
		if = {
			limit = { has_estate = estate_slaves }
			distribute_land_effect = { estate = estate_slaves }
		}
	}
}

#FROM = country dev was transferred from, ROOT = country doing the transferring
on_transfer_development = {
	FROM = {
		if = {
			limit = { has_estate = estate_slaves }
			distribute_land_effect = { estate = estate_slaves }
		}
	}
	ROOT = {
		if = {
			limit = { has_estate = estate_slaves }
			distribute_land_effect = { estate = estate_slaves }
		}
	}
}